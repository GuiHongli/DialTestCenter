# 用户角色管理模块软件实现设计文档

## 1 需求重述

### 1.1 需求背景
用户角色管理模块是DialTestCenter系统的核心权限管理功能，用于管理系统中的用户-角色关系，实现基于角色的访问控制（RBAC）。该模块为拨测系统提供细粒度的权限管理，确保不同角色用户只能访问其权限范围内的功能。

### 1.2 需求功能介绍
用户角色管理模块主要提供以下能力：
- 用户-角色关系的增删改查操作
- 基于角色的权限验证和拦截
- 内置管理员账号初始化
- 与执行机管理模块的联动机制
- 用户角色管理页面
- 权限验证和拦截机制
- **操作记录功能**：记录所有用户角色相关操作到操作记录模块
- **权限校验方案**：支持前端控制和后台控制两种权限校验模式

## 2 功能实现分析

### 2.1 功能点清单
1. **用户角色关系数据管理**：用户-角色表的CRUD操作
2. **权限验证机制**：基于角色的接口访问控制
3. **管理员初始化**：系统启动时自动创建管理员账号
4. **用户角色管理页面**：前端管理界面
5. **执行机联动机制**：新增执行机时自动分配EXECUTOR角色
6. **权限拦截器**：统一的权限验证拦截机制
7. **操作记录集成**：所有用户角色操作记录到操作记录模块
8. **权限校验方案**：前端控制和后台控制两种权限校验模式

### 2.2 功能点1：用户角色关系数据管理

#### 详细描述

**数据库表设计：**
```sql
-- 用户角色关系表
CREATE TABLE user_roles (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    role VARCHAR(20) NOT NULL,
    UNIQUE(username, role)
);

-- 角色枚举表
CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    code VARCHAR(20) NOT NULL UNIQUE,
    name_zh VARCHAR(50) NOT NULL,
    name_en VARCHAR(50) NOT NULL,
    description_zh TEXT,
    description_en TEXT
);
```

**核心实体类：**
```java
@Entity
@Table(name = "user_roles")
public class UserRole {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "username", nullable = false, length = 50)
    private String username;
    
    @Column(name = "role", nullable = false, length = 20)
    private String role;
    
    // 构造函数、getter、setter等
}

@Entity
@Table(name = "roles")
public class Role {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "code", nullable = false, unique = true, length = 20)
    private String code;
    
    @Column(name = "name_zh", nullable = false, length = 50)
    private String nameZh;
    
    @Column(name = "name_en", nullable = false, length = 50)
    private String nameEn;
    
    @Column(name = "description_zh")
    private String descriptionZh;
    
    @Column(name = "description_en")
    private String descriptionEn;
    
    // 构造函数、getter、setter等
}
```

**服务层实现：**
```java
@Service
@Transactional
public class UserRoleService {
    
    @Autowired
    private UserRoleDao userRoleDao;
    
    @Autowired
    private UserRoleOperationLogUtil operationLogUtil;
    
    public UserRole createUserRole(String username, String role, String operatorUsername) {
        // 验证角色有效性
        if (!isValidRole(role)) {
            throw new IllegalArgumentException("无效的角色: " + role);
        }
        
        // 检查是否已存在
        if (userRoleDao.existsByUsernameAndRole(username, role)) {
            throw new IllegalArgumentException("用户角色关系已存在");
        }
        
        // 创建用户角色关系
        UserRole userRole = new UserRole();
        userRole.setUsername(username);
        userRole.setRole(role);
        
        UserRole savedUserRole = userRoleDao.save(userRole);
        
        // 记录操作日志到操作记录模块
        operationLogUtil.logUserRoleCreate(operatorUsername, username, role);
        
        return savedUserRole;
    }
    
    public Page<UserRole> getUserRolesWithPagination(int page, int size, String search) {
        Pageable pageable = PageRequest.of(page, size);
        if (search != null && !search.trim().isEmpty()) {
            return userRoleDao.findByUsernameContainingIgnoreCase(search, pageable);
        }
        return userRoleDao.findAll(pageable);
    }
    
    public List<String> getUserRolesByUsername(String username) {
        return userRoleDao.findByUsername(username)
                .stream()
                .map(UserRole::getRole)
                .collect(Collectors.toList());
    }
    
    public boolean hasRole(String username, String role) {
        return userRoleDao.existsByUsernameAndRole(username, role);
    }
    
    public boolean hasAnyRole(String username, List<String> roles) {
        return userRoleDao.existsByUsernameAndRoleIn(username, roles);
    }
    
    private boolean isValidRole(String role) {
        return Arrays.asList("ADMIN", "OPERATOR", "BROWSER", "EXECUTOR").contains(role);
    }
}
```

### 2.3 功能点2：权限验证机制

#### 详细描述

**权限注解设计：**
```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireRole {
    Role[] value() default {};
    boolean requireAll() default false;
}

public enum Role {
    ADMIN("管理员", "拥有所有权限"),
    OPERATOR("操作员", "可以执行拨测任务相关的所有操作"),
    BROWSER("浏览者", "仅查看"),
    EXECUTOR("执行机", "执行机注册使用");
}
```

**权限拦截器实现：**
```java
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Autowired
    private UserRoleService userRoleService;
    
    @Autowired
    private OperationLogService operationLogService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 获取请求头中的用户名
        String username = request.getHeader("X-Username");
        if (username == null || username.isEmpty()) {
            response.setStatus(401);
            return false;
        }
        
        // 检查方法上的权限注解
        RequireRole requireRole = getRequireRoleAnnotation(handler);
        if (requireRole != null) {
            // 查询用户角色
            List<String> userRoles = userRoleService.getUserRolesByUsername(username);
            
            // 验证权限
            if (!hasRequiredRoles(userRoles, requireRole)) {
                // 记录权限检查失败日志
                operationLogService.logOperation(
                    username, "PERMISSION_DENIED", "USER_ROLE", 
                    "权限检查失败: " + request.getRequestURI()
                );
                
                response.setStatus(403);
                return false;
            }
            
            // 记录权限检查成功日志
            operationLogService.logOperation(
                username, "PERMISSION_CHECK", "USER_ROLE", 
                "权限检查成功: " + request.getRequestURI()
            );
        }
        
        return true;
    }
    
    private boolean hasRequiredRoles(List<String> userRoles, RequireRole requireRole) {
        Role[] requiredRoles = requireRole.value();
        boolean requireAll = requireRole.requireAll();
        
        if (requireAll) {
            // 需要拥有所有指定角色
            return Arrays.stream(requiredRoles)
                .allMatch(role -> userRoles.contains(role.name()));
        } else {
            // 需要拥有任一指定角色
            return Arrays.stream(requiredRoles)
                .anyMatch(role -> userRoles.contains(role.name()));
        }
    }
}
```

### 2.4 功能点3：操作记录集成

#### 详细描述

**操作记录工具类：**
```java
@Component
public class UserRoleOperationLogUtil {
    
    @Autowired
    private OperationLogService operationLogService;
    
    public void logUserRoleCreate(String operatorUsername, String targetUsername, String role) {
        String descriptionZh = String.format("创建用户角色: %s -> %s", targetUsername, role);
        String descriptionEn = String.format("Create user role: %s -> %s", targetUsername, role);
        
        operationLogService.logOperation(
            operatorUsername, "CREATE", "USER_ROLE", 
            descriptionZh, descriptionEn,
            Map.of("targetUsername", targetUsername, "role", role)
        );
    }
    
    public void logUserRoleUpdate(String operatorUsername, String targetUsername, String oldRole, String newRole) {
        String descriptionZh = String.format("更新用户角色: %s %s -> %s", targetUsername, oldRole, newRole);
        String descriptionEn = String.format("Update user role: %s %s -> %s", targetUsername, oldRole, newRole);
        
        operationLogService.logOperation(
            operatorUsername, "UPDATE", "USER_ROLE", 
            descriptionZh, descriptionEn,
            Map.of("targetUsername", targetUsername, "oldRole", oldRole, "newRole", newRole)
        );
    }
    
    public void logUserRoleDelete(String operatorUsername, String targetUsername, String role) {
        String descriptionZh = String.format("删除用户角色: %s -> %s", targetUsername, role);
        String descriptionEn = String.format("Delete user role: %s -> %s", targetUsername, role);
        
        operationLogService.logOperation(
            operatorUsername, "DELETE", "USER_ROLE", 
            descriptionZh, descriptionEn,
            Map.of("targetUsername", targetUsername, "role", role)
        );
    }
}
```

### 2.5 功能点4：控制器实现

#### 详细描述

**REST控制器：**
```java
@RestController
@RequestMapping("/api/user-roles")
public class UserRoleController {
    
    @Autowired
    private UserRoleService userRoleService;
    
    @GetMapping
    @RequireRole({Role.ADMIN, Role.OPERATOR})
    public ResponseEntity<UserRolePageResponse> getUserRoles(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(required = false) String search,
            @RequestHeader("X-Username") String username) {
        
        try {
            Page<UserRole> userRolePage = userRoleService.getUserRolesWithPagination(page, size, search);
            
            UserRolePageResponse response = new UserRolePageResponse();
            response.setSuccess(true);
            response.setData(userRolePage);
            response.setMessage("获取用户角色列表成功");
            
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            UserRolePageResponse response = new UserRolePageResponse();
            response.setSuccess(false);
            response.setMessage("获取用户角色列表失败: " + e.getMessage());
            return ResponseEntity.status(500).body(response);
        }
    }
    
    @PostMapping
    @RequireRole({Role.ADMIN})
    public ResponseEntity<UserRoleResponse> createUserRole(
            @RequestBody CreateUserRoleRequest request,
            @RequestHeader("X-Username") String username) {
        
        try {
            UserRole userRole = userRoleService.createUserRole(
                request.getUsername(), 
                request.getRole(), 
                username
            );
            
            UserRoleResponse response = new UserRoleResponse();
            response.setSuccess(true);
            response.setData(userRole);
            response.setMessage("创建用户角色成功");
            
            return ResponseEntity.status(201).body(response);
        } catch (IllegalArgumentException e) {
            UserRoleResponse response = new UserRoleResponse();
            response.setSuccess(false);
            response.setMessage(e.getMessage());
            return ResponseEntity.status(400).body(response);
        } catch (Exception e) {
            UserRoleResponse response = new UserRoleResponse();
            response.setSuccess(false);
            response.setMessage("创建用户角色失败: " + e.getMessage());
            return ResponseEntity.status(500).body(response);
        }
    }
    
    @PostMapping("/check-permission")
    public ResponseEntity<PermissionCheckResponse> checkUserPermission(
            @RequestBody CheckPermissionRequest request,
            @RequestHeader("X-Username") String username) {
        
        try {
            List<String> userRoles = userRoleService.getUserRolesByUsername(request.getUsername());
            boolean hasPermission = userRoleService.hasAnyRole(request.getUsername(), request.getRoles());
            
            PermissionCheckResponse response = new PermissionCheckResponse();
            response.setSuccess(true);
            response.setData(new PermissionCheckData(hasPermission, userRoles));
            response.setMessage("权限检查完成");
            
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            PermissionCheckResponse response = new PermissionCheckResponse();
            response.setSuccess(false);
            response.setMessage("权限检查失败: " + e.getMessage());
            return ResponseEntity.status(500).body(response);
        }
    }
}
```

## 3 AR开发者测试设计

### 3.1 被测对象分析

**后端测试对象：**
- `UserRoleController`：控制器层测试
- `UserRoleService`：服务层测试
- `UserRole`：模型层测试
- `PermissionInterceptor`：权限拦截器测试
- `UserRoleOperationLogUtil`：操作记录工具类测试

**前端测试对象：**
- `UserRoleManagement`：用户角色管理组件测试
- `UserRoleForm`：用户角色表单组件测试
- `userRoleService`：API服务层测试
- `usePermission`：权限检查Hook测试

### 3.2 DT用例设计列表

#### 3.2.1 UserRoleController测试用例

**主场景测试：**
1. **TC001_分页查询用户角色_正常场景**
   - 被测方法：`getUserRoles(page, size, search)`
   - 测试因子：page=0, size=10, search=null, X-Username=admin
   - 预期结果：返回用户角色列表，success=true，记录VIEW操作日志

2. **TC002_分页查询用户角色_带搜索条件**
   - 被测方法：`getUserRoles(page, size, search)`
   - 测试因子：page=0, size=10, search="admin", X-Username=admin
   - 预期结果：返回匹配的用户角色列表，记录VIEW操作日志

3. **TC003_创建用户角色_正常场景**
   - 被测方法：`createUserRole(CreateUserRoleRequest)`
   - 测试因子：username="user1", role="OPERATOR", X-Username=admin
   - 预期结果：返回201 Created，用户角色创建成功，记录CREATE操作日志

4. **TC004_权限检查_正常场景**
   - 被测方法：`checkUserPermission(CheckPermissionRequest)`
   - 测试因子：username="user1", roles=["OPERATOR"], X-Username=admin
   - 预期结果：返回200 OK，权限检查结果，记录PERMISSION_CHECK操作日志

**异常场景测试：**
5. **TC005_创建用户角色_用户角色关系已存在**
   - 被测方法：`createUserRole(CreateUserRoleRequest)`
   - 测试因子：username="admin", role="ADMIN"（已存在）
   - 预期结果：返回409 Conflict

6. **TC006_创建用户角色_无效角色**
   - 被测方法：`createUserRole(CreateUserRoleRequest)`
   - 测试因子：username="user1", role="INVALID_ROLE"
   - 预期结果：返回400 Bad Request

7. **TC007_权限不足_非管理员访问**
   - 被测方法：`createUserRole(CreateUserRoleRequest)`
   - 测试因子：X-Username=operator（非管理员）
   - 预期结果：返回403 Forbidden

8. **TC008_未提供用户名**
   - 被测方法：`getUserRoles(page, size, search)`
   - 测试因子：无X-Username头
   - 预期结果：返回401 Unauthorized

#### 3.2.2 UserRoleService测试用例

**主场景测试：**
9. **TC009_服务层分页查询_正常场景**
    - 被测方法：`getUserRolesWithPagination(page, size, search)`
    - 测试因子：page=0, size=10, search=null
    - 预期结果：返回用户角色列表

10. **TC010_服务层创建用户角色_正常场景**
    - 被测方法：`createUserRole(username, role, operatorUsername)`
    - 测试因子：username="testuser", role="OPERATOR", operatorUsername="admin"
    - 预期结果：返回创建的用户角色对象

11. **TC011_服务层权限检查_正常场景**
    - 被测方法：`hasRole(username, role)`
    - 测试因子：username="user1", role="OPERATOR"
    - 预期结果：返回权限检查结果

**异常场景测试：**
12. **TC012_服务层创建用户角色_用户角色关系已存在**
    - 被测方法：`createUserRole(username, role, operatorUsername)`
    - 测试因子：username="admin", role="ADMIN"（已存在）
    - 预期结果：抛出IllegalArgumentException

13. **TC013_服务层创建用户角色_无效角色**
    - 被测方法：`createUserRole(username, role, operatorUsername)`
    - 测试因子：username="user1", role="INVALID_ROLE"
    - 预期结果：抛出IllegalArgumentException

#### 3.2.3 PermissionInterceptor测试用例

**主场景测试：**
14. **TC014_权限拦截器_管理员访问**
    - 被测方法：`preHandle(request, response, handler)`
    - 测试因子：X-Username=admin, @RequireRole(ADMIN)
    - 预期结果：返回true，允许访问

15. **TC015_权限拦截器_操作员访问**
    - 被测方法：`preHandle(request, response, handler)`
    - 测试因子：X-Username=operator, @RequireRole(OPERATOR)
    - 预期结果：返回true，允许访问

**异常场景测试：**
16. **TC016_权限拦截器_权限不足**
    - 被测方法：`preHandle(request, response, handler)`
    - 测试因子：X-Username=browser, @RequireRole(ADMIN)
    - 预期结果：返回false，设置403状态码

17. **TC017_权限拦截器_未提供用户名**
    - 被测方法：`preHandle(request, response, handler)`
    - 测试因子：无X-Username头
    - 预期结果：返回false，设置401状态码

#### 3.2.4 UserRoleOperationLogUtil测试用例

**主场景测试：**
18. **TC018_操作记录工具_记录创建操作**
    - 被测方法：`logUserRoleCreate(operatorUsername, targetUsername, role)`
    - 测试因子：operatorUsername="admin", targetUsername="user1", role="OPERATOR"
    - 预期结果：成功记录操作日志

19. **TC019_操作记录工具_记录更新操作**
    - 被测方法：`logUserRoleUpdate(operatorUsername, targetUsername, oldRole, newRole)`
    - 测试因子：operatorUsername="admin", targetUsername="user1", oldRole="OPERATOR", newRole="ADMIN"
    - 预期结果：成功记录操作日志

20. **TC020_操作记录工具_记录删除操作**
    - 被测方法：`logUserRoleDelete(operatorUsername, targetUsername, role)`
    - 测试因子：operatorUsername="admin", targetUsername="user1", role="OPERATOR"
    - 预期结果：成功记录操作日志
