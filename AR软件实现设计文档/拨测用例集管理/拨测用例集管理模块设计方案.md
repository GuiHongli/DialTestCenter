# 拨测用例集管理模块设计方案

## 1. 需求概述

### 1.1 功能需求
拨测用例集管理模块需要支持以下核心功能：

**用例集管理功能：**
- 支持上传拨测用例集包（ZIP格式）：仅ADMIN和OPERATOR有权限
- 支持下载用例集包：仅ADMIN和OPERATOR有权限  
- 支持用例集信息的编辑和删除：仅ADMIN和OPERATOR有权限
- 支持用例集列表的分页查询展示：所有人均有查看权限
- 用例集关键信息：用例集名称、用例集版本、描述、文件内容、文件sha256值、业务名称
- 业务名称区分中英文：中文为'VPN阻断'，英文为'VPN_BLOCK'
- ZIP命名规则：`用例集名称_用例集版本.zip`，示例：`短视频采集_v0.1.zip`
- ZIP包大小限定为100MB
- 用例集名称和版本组合必须唯一，支持强制覆盖功能
- 除预览外的所有人工操作均需要记录到操作记录模块

**压缩包解析和用例信息存储功能：**
- 支持解析ZIP格式的压缩包
- 自动提取压缩包中的`cases.xlsx`文件并解析用例信息
- 用例信息包括：用例名称、用例编号、用例测试步骤、用例预期结果、用例业务大类、用例App、依赖的软件包、依赖的规则、依赖的运行环境描述（json）
- 业务大类、App需要存储为单独的应用类型表
- 自动提取`scripts`目录下的Python脚本文件名列表
- 匹配用例编号与对应的Python脚本文件，规则为用例编号等于文件名
- 记录缺失脚本的用例信息
- 在前端页面展示测试用例详情和缺失脚本警告
- 提供测试用例统计信息（总用例数、已匹配、缺失脚本、匹配率）

### 1.2 权限控制
- ADMIN：拥有所有权限
- OPERATOR：可以执行拨测任务相关的所有操作，可查看用户角色管理页面，不可操作
- BROWSER：仅查看，可查看用户角色管理页面，不可操作
- EXECUTOR：执行机注册使用，不可查看

## 2. 系统架构设计

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端层        │    │   后端层        │    │   数据层        │
│                 │    │                 │    │                 │
│ React + TS      │◄──►│ Spring Boot     │◄──►│ PostgreSQL      │
│ Ant Design      │    │ JPA/Hibernate   │    │ BYTEA存储       │
│ i18n支持        │    │ RESTful API     │    │ 索引优化        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 技术栈
- **后端**：Spring Boot 2.7.18 + Mybatis + PostgreSQL
- **前端**：React 18 + TypeScript + Ant Design 5.x
- **文件处理**：Apache POI (Excel解析) + Apache Commons Compress (ZIP解析)
- **测试**：JUnit 4 + Mockito 4.11.0

## 3. 数据库设计

### 3.1 用例集表（test_case_set）
```sql
CREATE TABLE test_case_set (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    version VARCHAR(50) NOT NULL,
    file_content BYTEA NOT NULL,
    file_size BIGINT NOT NULL,
    description VARCHAR(1000),
    sha256 VARCHAR(64),
    business VARCHAR(50) DEFAULT 'VPN阻断',
    business_en VARCHAR(50) DEFAULT 'VPN_BLOCK',
    CONSTRAINT uk_name_version UNIQUE (name, version)
);

CREATE INDEX idx_test_case_set_name ON test_case_set (name);
```

### 3.2 测试用例表（test_case）
```sql
CREATE TABLE test_case (
    id BIGSERIAL PRIMARY KEY,
    test_case_set_id BIGINT NOT NULL,
    case_name VARCHAR(200) NOT NULL,
    case_number VARCHAR(100) NOT NULL,
    test_steps TEXT,
    expected_result TEXT,
    business_category VARCHAR(200),
    app_name VARCHAR(200),
    dependencies_package TEXT,
    dependencies_rule TEXT,
    environment_config JSONB,
    script_exists BOOLEAN NOT NULL DEFAULT FALSE,
    CONSTRAINT fk_test_case_set_id FOREIGN KEY (test_case_set_id) REFERENCES test_case_set(id) ON DELETE CASCADE,
    CONSTRAINT uk_test_case_set_case_number UNIQUE (test_case_set_id, case_number)
);

CREATE INDEX idx_test_case_set_id ON test_case (test_case_set_id);
CREATE INDEX idx_case_number ON test_case (case_number);
CREATE INDEX idx_script_exists ON test_case (script_exists);
```

### 3.3 应用类型表（app_type）
```sql
CREATE TABLE app_type (
    id BIGSERIAL PRIMARY KEY,
    business_category VARCHAR(200) NOT NULL,
    app_name VARCHAR(200) NOT NULL,
    description VARCHAR(500),
    CONSTRAINT uk_business_app UNIQUE (business_category, app_name)
);

CREATE INDEX idx_app_type_category ON app_type (business_category);
CREATE INDEX idx_app_type_app ON app_type (app_name);
```

### 3.4 表关联关系说明

**表关联关系图：**
```
test_case_set (用例集表)
    │
    │ 1:N (一对多)
    │
    ▼
test_case (测试用例表)
    │
    │ N:1 (多对一)
    │
    ▼
app_type (应用类型表)
```

**详细关联关系：**

1. **test_case_set ↔ test_case (一对多关系)**
   - 一个用例集可以包含多个测试用例
   - 通过 `test_case.test_case_set_id` 外键关联到 `test_case_set.id`
   - 使用级联删除：删除用例集时，相关的测试用例也会被删除
   - 约束：`CONSTRAINT fk_test_case_set_id FOREIGN KEY (test_case_set_id) REFERENCES test_case_set(id) ON DELETE CASCADE`

2. **test_case ↔ app_type (多对一关系)**
   - 多个测试用例可以属于同一个应用类型
   - 通过 `test_case.business_category` 和 `test_case.app_name` 字段关联到 `app_type.business_category` 和 `app_type.app_name`
   - 这是逻辑关联，不是物理外键约束
   - 应用类型表用于标准化和分类管理

**关联查询示例：**

```sql
-- 查询用例集及其包含的测试用例
SELECT 
    tcs.name as case_set_name,
    tcs.version,
    tc.case_name,
    tc.case_number,
    tc.script_exists
FROM test_case_set tcs
LEFT JOIN test_case tc ON tcs.id = tc.test_case_set_id
WHERE tcs.name = '短视频采集';

-- 查询测试用例及其应用类型信息
SELECT 
    tc.case_name,
    tc.case_number,
    tc.business_category,
    tc.app_name,
    at.description as app_description
FROM test_case tc
LEFT JOIN app_type at ON tc.business_category = at.business_category 
    AND tc.app_name = at.app_name
WHERE tc.test_case_set_id = 1;

-- 统计每个用例集的测试用例数量和缺失脚本数量
SELECT 
    tcs.name,
    tcs.version,
    COUNT(tc.id) as total_cases,
    COUNT(CASE WHEN tc.script_exists = false THEN 1 END) as missing_scripts
FROM test_case_set tcs
LEFT JOIN test_case tc ON tcs.id = tc.test_case_set_id
GROUP BY tcs.id, tcs.name, tcs.version;
```

**数据完整性保证：**

1. **物理约束：**
   - 用例集与测试用例之间通过外键约束保证数据完整性
   - 级联删除确保数据一致性

2. **逻辑约束：**
   - 测试用例的应用类型信息通过应用类型表进行标准化
   - 业务大类和App名称的组合在应用类型表中必须唯一

3. **业务约束：**
   - 用例集名称和版本组合必须唯一
   - 同一用例集内的测试用例编号必须唯一
   - 应用类型的业务大类和App名称组合必须唯一

## 4. API设计

### 4.1 RESTful API接口

| 方法 | 路径 | 功能 | 权限要求 |
|------|------|------|----------|
| GET | `/api/test-case-sets` | 获取用例集列表 | 所有角色 |
| GET | `/api/test-case-sets/{id}` | 获取用例集详情 | 所有角色 |
| POST | `/api/test-case-sets/upload` | 上传用例集 | ADMIN, OPERATOR |
| GET | `/api/test-case-sets/{id}/download` | 下载用例集 | ADMIN, OPERATOR |
| PUT | `/api/test-case-sets/{id}` | 更新用例集 | ADMIN, OPERATOR |
| DELETE | `/api/test-case-sets/{id}` | 删除用例集 | ADMIN, OPERATOR |
| GET | `/api/test-case-sets/{id}/test-cases` | 获取测试用例列表 | 所有角色 |
| GET | `/api/test-case-sets/{id}/missing-scripts` | 获取缺失脚本列表 | 所有角色 |

### 4.2 关键API实现逻辑

**更新用例集API：**
```java
@PutMapping("/{id}")
public ResponseEntity<Map<String, Object>> updateTestCaseSet(
        @PathVariable Long id,
        @RequestBody Map<String, String> request) {
    
    // 1. 权限验证（ADMIN, OPERATOR）
    // 2. 根据ID查询用例集是否存在
    // 3. 验证更新数据：
    //    - 描述信息（可选）
    //    - 业务类型（可选）
    // 4. 更新数据库记录
    // 5. 记录操作日志
    // 6. 返回更新结果
}
```

**更新用例集主要更新内容：**
- **描述信息**：更新用例集的详细描述
- **业务类型**：修改业务分类（中文和英文）
- **限制**：
  - 用例集名称和版本不允许更新，保持与ZIP包文件名一致
  - 文件内容（ZIP包）不支持更新，如需更新文件内容需要重新上传

**上传用例集API：**
```java
@PostMapping("/upload")
public ResponseEntity<Map<String, Object>> uploadTestCaseSet(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "description", required = false) String description) {
    
    // 1. 权限验证
    // 2. 文件验证（大小、格式、命名）
    // 3. 文件名解析（提取名称和版本）
    // 4. 重复性检查和覆盖处理
    // 5. 压缩包解析（提取cases.xlsx和scripts目录）
    // 6. Excel文件解析（提取用例信息）
    // 7. 脚本文件匹配（匹配用例编号与脚本文件）
    // 8. 数据库保存（用例集和测试用例）
    // 9. 操作记录
    // 10. 返回结果
}
```

## 5. 前端设计

### 5.1 页面布局

**用例集管理页面：**
```
┌─────────────────────────────────────────────────────────────┐
│  📁 用例集管理                                    [上传] [刷新] │
├─────────────────────────────────────────────────────────────┤
│ 用例集名称    │ 版本  │ 文件大小 │ 业务类型 │ 操作    │
├─────────────────────────────────────────────────────────────┤
│ 短视频采集    │ v0.1  │ 2.5MB   │ VPN阻断  │ [编辑][删除][下载][查看测试用例] │
│ 网络测试      │ v1.0  │ 1.8MB   │ VPN阻断  │ [编辑][删除][下载][查看测试用例] │
└─────────────────────────────────────────────────────────────┘
```

**测试用例详情页面：**
```
┌─────────────────────────────────────────────────────────────┐
│  📋 测试用例详情 - 短视频采集_v0.1                              │
├─────────────────────────────────────────────────────────────┤
│ 📊 统计信息                                                  │
│ ┌─────────┬─────────┬─────────┬─────────┐                    │
│ │ 总用例数 │ 已匹配  │ 缺失脚本 │ 匹配率  │                    │
│ │   25    │   20    │    5    │  80%   │                    │
│ └─────────┴─────────┴─────────┴─────────┘                    │
├─────────────────────────────────────────────────────────────┤
│ ⚠️ 发现缺失脚本：有 5 个测试用例缺少对应的Python脚本文件        │
│ [查看详情]                                                   │
├─────────────────────────────────────────────────────────────┤
│ [所有用例(25)] [缺失脚本(5)]                                  │
├─────────────────────────────────────────────────────────────┤
│ 用例编号 │ 用例名称 │ 业务大类 │ App名称 │ 脚本状态 │ 操作    │
├─────────────────────────────────────────────────────────────┤
│ TC001   │ 测试用例1 │ 业务大类1│ 应用1  │ 已匹配  │ [详情]  │
│ TC002   │ 测试用例2 │ 业务大类2│ 应用2  │ 缺失    │ [详情]  │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 组件设计

**主要组件：**
- `TestCaseSetManagement`：主管理页面组件
- `TestCaseSetUpload`：上传组件
- `TestCaseSetEdit`：编辑组件（新增）
- `TestCaseDetails`：测试用例详情组件
- `TestCaseSetService`：API服务类

**编辑功能设计：**
- 点击"编辑"按钮打开编辑对话框
- 可编辑字段：描述、业务类型
- 不可编辑字段：用例集名称、版本（保持与ZIP包文件名一致）
- 表单验证：描述信息长度限制，业务类型必选
- 支持中英文业务类型选择
- 编辑成功后刷新列表并显示成功提示

## 6. 后端服务设计

### 6.1 服务层架构

**核心服务类：**
- `TestCaseSetService`：用例集管理服务
- `TestCaseService`：测试用例管理服务
- `ArchiveParseService`：压缩包解析服务
- `ExcelParseService`：Excel文件解析服务
- `ScriptMatchService`：脚本匹配服务

### 6.2 关键算法

**文件名解析算法：**
```java
public void parseFileName(String fileName) {
    if (!fileName.endsWith(".zip")) {
        throw new IllegalArgumentException("只支持ZIP格式文件");
    }
    
    String nameWithoutExt = fileName.substring(0, fileName.lastIndexOf(".zip"));
    int lastUnderscoreIndex = nameWithoutExt.lastIndexOf("_");
    if (lastUnderscoreIndex == -1) {
        throw new IllegalArgumentException("文件名格式错误");
    }
    
    String name = nameWithoutExt.substring(0, lastUnderscoreIndex);
    String version = nameWithoutExt.substring(lastUnderscoreIndex + 1);
    
    return {name, version};
}
```

## 7. 测试设计

### 7.1 测试覆盖范围
- **Service层测试**：38个测试用例
- **Controller层测试**：22个测试用例  
- **Entity层测试**：16个测试用例
- **总测试用例数**：76个
- **代码覆盖率**：预计超过85%

### 7.2 测试策略
- 使用JUnit 4 + Mockito进行单元测试
- 覆盖所有正常业务流程和异常处理场景
- 使用Mock对象，不依赖外部系统
- 测试数据独立，避免相互影响

## 8. 部署和配置

### 8.1 环境要求
- JDK 8+
- PostgreSQL 12+
- Node.js 16+
- Maven 3.6+

### 8.2 配置文件
- `application.yml`：Spring Boot配置
- `package.json`：前端依赖配置
- 数据库初始化脚本

## 9. 安全考虑

### 9.1 文件安全
- 文件类型限制：只允许ZIP格式
- 文件大小限制：100MB
- 文件名验证：防止路径遍历攻击
- 压缩包结构验证：必须包含指定文件结构

### 9.2 数据安全
- 输入验证：对所有用户输入进行验证
- SQL注入防护：使用JPA参数化查询
- 权限控制：基于角色的访问控制

## 10. 性能优化

### 10.1 数据库优化
- 索引设计：为常用查询字段创建索引
- 分页查询：避免一次性加载大量数据
- 连接池：使用数据库连接池

### 10.2 前端优化
- 懒加载：使用分页加载
- 缓存策略：合理使用浏览器缓存
- 组件优化：使用React.memo优化渲染

## 11. 扩展性设计

### 11.1 功能扩展
- 支持更多文件格式（TAR.GZ等）
- 支持更多Excel格式
- 支持更多脚本语言

### 11.2 架构扩展
- 微服务化：支持服务拆分
- 水平扩展：支持多实例部署
- 配置化：参数可配置

## 12. 实施计划

### 12.1 开发阶段
1. **数据库设计**：创建表结构和索引
2. **后端开发**：实现服务层和控制器
3. **前端开发**：实现组件和页面
4. **测试开发**：编写单元测试
5. **集成测试**：端到端测试

### 12.2 部署阶段
1. **环境准备**：配置开发、测试、生产环境
2. **数据迁移**：执行数据库脚本
3. **应用部署**：部署后端和前端应用
4. **功能验证**：验证所有功能正常

## 13. 风险评估

### 13.1 技术风险
- 大文件上传性能问题
- 压缩包解析内存占用
- 数据库存储空间限制

### 13.2 业务风险
- 文件格式兼容性问题
- 用例数据解析准确性
- 权限控制安全性

## 14. 总结

本设计方案提供了拨测用例集管理模块的完整技术实现方案，包括数据库设计、API设计、前端设计、后端服务设计、测试设计等各个方面。方案考虑了安全性、性能、扩展性等非功能性需求，为后续的开发实施提供了详细的技术指导。
