# 拨测用例集管理模块软件实现设计文档

## 1 需求重述

### 1.1 需求背景
拨测控制中心需要支持拨测用例集的管理，提供完整的用例集生命周期管理功能，包括上传、下载、编辑、删除等操作。同时需要支持压缩包解析和用例信息存储功能。

### 1.2 需求功能介绍
拨测控制中心支持配置管理，其中用例集管理是核心功能之一：

**用例集管理功能：**
- 支持上传拨测用例集包（ZIP格式）：仅ADMIN和OPERATOR有权限
- 支持下载用例集包：仅ADMIN和OPERATOR有权限  
- 支持用例集信息的编辑和删除：仅ADMIN和OPERATOR有权限
- 支持用例集列表的分页查询展示：所有人均有查看权限
- 用例集关键信息：用例集名称、用例集版本、描述、文件内容、文件sha256值、业务名称
- 业务名称区分中英文：中文为'VPN阻断'，英文为'VPN_BLOCK'
- ZIP命名规则：`用例集名称_用例集版本.zip`，示例：`短视频采集_v0.1.zip`
- ZIP包大小限定为100MB
- 用例集名称和版本组合必须唯一，支持强制覆盖功能
- 除预览外的所有人工操作均需要记录到操作记录模块

**压缩包解析和用例信息存储功能：**
- 支持解析ZIP格式的压缩包
- 自动提取压缩包中的`cases.xlsx`文件并解析用例信息
- 用例信息包括：用例名称、用例编号、用例测试步骤、用例预期结果、用例业务大类、用例App、依赖的软件包、依赖的规则、依赖的运行环境描述（文本格式）
- 业务大类、App需要存储为单独的应用类型表
- 自动提取`scripts`目录下的Python脚本文件名列表
- 匹配用例编号与对应的Python脚本文件，规则为用例编号等于文件名
- 记录缺失脚本的用例信息
- 在前端页面展示测试用例详情和缺失脚本警告
- 提供测试用例统计信息（总用例数、已匹配、缺失脚本、匹配率）

## 2 功能实现分析

### 2.1 功能点清单
#### 2.1.1 用例集上传功能
#### 2.1.2 用例集下载功能
#### 2.1.3 用例集列表查询功能
#### 2.1.4 用例集信息编辑功能
#### 2.1.5 用例集删除功能
#### 2.1.6 压缩包解析功能
#### 2.1.7 Excel文件解析功能
#### 2.1.8 脚本文件匹配功能
#### 2.1.9 测试用例详情查看功能
#### 2.1.10 缺失脚本统计功能

### 2.2 功能点1：用例集上传功能

#### 详细描述

**数据库表设计：**
```sql
-- 用例集表
CREATE TABLE test_case_set (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    version VARCHAR(50) NOT NULL,
    file_content BYTEA NOT NULL,
    file_size BIGINT NOT NULL,
    description VARCHAR(1000),
    sha256 VARCHAR(64),
    business VARCHAR(50) DEFAULT 'VPN阻断',
    business_en VARCHAR(50) DEFAULT 'VPN_BLOCK',
    CONSTRAINT uk_name_version UNIQUE (name, version)
);

-- 测试用例表
CREATE TABLE test_case (
    id BIGSERIAL PRIMARY KEY,
    test_case_set_id BIGINT NOT NULL,
    case_name VARCHAR(200) NOT NULL,
    case_number VARCHAR(100) NOT NULL,
    test_steps TEXT,
    expected_result TEXT,
    business_category VARCHAR(200),
    app_name VARCHAR(200),
    dependencies_package TEXT,
    dependencies_rule TEXT,
    environment_config TEXT,
    script_exists BOOLEAN NOT NULL DEFAULT FALSE,
    CONSTRAINT fk_test_case_set_id FOREIGN KEY (test_case_set_id) REFERENCES test_case_set(id) ON DELETE CASCADE,
    CONSTRAINT uk_test_case_set_case_number UNIQUE (test_case_set_id, case_number)
);

-- 应用类型表
CREATE TABLE app_type (
    id BIGSERIAL PRIMARY KEY,
    business_category VARCHAR(200) NOT NULL,
    app_name VARCHAR(200) NOT NULL,
    description VARCHAR(500),
    CONSTRAINT uk_business_app UNIQUE (business_category, app_name)
);
```

**算法流程图：**
```
开始
  ↓
接收上传文件
  ↓
文件验证（大小、格式、命名）
  ↓
文件名解析（提取名称和版本）
  ↓
检查重复性
  ↓
压缩包解析
  ↓
Excel文件解析
  ↓
脚本文件匹配
  ↓
保存到数据库
  ↓
记录操作日志
  ↓
返回结果
  ↓
结束
```

**函数伪代码：**
```java
public TestCaseSet uploadTestCaseSet(MultipartFile file, String description, String business) {
    // 1. 文件验证
    validateFile(file);
    
    // 2. 文件名解析
    FileNameInfo fileNameInfo = parseFileName(file.getOriginalFilename());
    
    // 3. 重复性检查
    checkDuplicate(fileNameInfo.getName(), fileNameInfo.getVersion());
    
    // 4. 读取文件内容
    byte[] fileContent = file.getBytes();
    
    // 5. 压缩包解析
    ArchiveParseResult archiveResult = archiveParseService.parseArchive(fileContent);
    
    // 6. Excel文件解析
    List<TestCaseInfo> testCases = excelParseService.parseExcel(archiveResult.getExcelData());
    
    // 7. 脚本文件匹配
    List<TestCaseInfo> matchedTestCases = scriptMatchService.matchScripts(testCases, archiveResult.getScriptFileNames());
    
    // 8. 保存用例集
    TestCaseSet testCaseSet = saveTestCaseSet(fileNameInfo, fileContent, description, business);
    
    // 9. 保存测试用例
    saveTestCases(testCaseSet.getId(), matchedTestCases);
    
    // 10. 记录操作日志
    operationLogUtil.logTestCaseSetUpload(currentUser, testCaseSet);
    
    return testCaseSet;
}
```

**对象类图：**
```
TestCaseSetController
    ↓
TestCaseSetService
    ↓
ArchiveParseService
    ↓
ExcelParseService
    ↓
ScriptMatchService
    ↓
TestCaseSetDao
    ↓
TestCaseDao
    ↓
AppTypeDao
```

### 2.3 功能点2：压缩包解析功能

#### 详细描述

**算法流程图：**
```
开始
  ↓
读取ZIP文件内容
  ↓
创建ZIP输入流
  ↓
遍历ZIP条目
  ↓
查找cases.xlsx文件
  ↓
提取Excel文件内容
  ↓
查找scripts目录
  ↓
提取Python脚本文件名
  ↓
返回解析结果
  ↓
结束
```

**函数伪代码：**
```java
public ArchiveParseResult parseArchive(byte[] archiveData) {
    ArchiveParseResult result = new ArchiveParseResult();
    
    try (ZipInputStream zipInputStream = new ZipInputStream(new ByteArrayInputStream(archiveData))) {
        ZipEntry entry;
        while ((entry = zipInputStream.getNextEntry()) != null) {
            String entryName = entry.getName();
            
            // 查找cases.xlsx文件
            if (entryName.equals("cases.xlsx")) {
                byte[] excelData = readEntryContent(zipInputStream);
                result.setExcelData(excelData);
            }
            
            // 查找scripts目录下的Python文件
            if (entryName.startsWith("scripts/") && entryName.endsWith(".py")) {
                String scriptFileName = entryName.substring(entryName.lastIndexOf("/") + 1);
                result.addScriptFileName(scriptFileName);
            }
        }
    } catch (IOException e) {
        throw new ArchiveParseException("解析压缩包失败", e);
    }
    
    return result;
}
```

### 2.4 功能点3：Excel文件解析功能

#### 详细描述

**算法流程图：**
```
开始
  ↓
创建Excel工作簿
  ↓
获取第一个工作表
  ↓
读取表头行
  ↓
遍历数据行
  ↓
提取用例信息
  ↓
创建TestCaseInfo对象
  ↓
添加到结果列表
  ↓
返回解析结果
  ↓
结束
```

**函数伪代码：**
```java
public List<TestCaseInfo> parseExcel(byte[] excelData) {
    List<TestCaseInfo> testCases = new ArrayList<>();
    
    try (ByteArrayInputStream inputStream = new ByteArrayInputStream(excelData);
         Workbook workbook = new XSSFWorkbook(inputStream)) {
        
        Sheet sheet = workbook.getSheetAt(0);
        
        // 读取表头
        Row headerRow = sheet.getRow(0);
        Map<String, Integer> columnIndexMap = buildColumnIndexMap(headerRow);
        
        // 读取数据行
        for (int i = 1; i <= sheet.getLastRowNum(); i++) {
            Row row = sheet.getRow(i);
            if (row == null) continue;
            
            TestCaseInfo testCase = new TestCaseInfo();
            testCase.setCaseName(getCellValue(row, columnIndexMap.get("用例名称")));
            testCase.setCaseNumber(getCellValue(row, columnIndexMap.get("用例编号")));
            testCase.setTestSteps(getCellValue(row, columnIndexMap.get("测试步骤")));
            testCase.setExpectedResult(getCellValue(row, columnIndexMap.get("预期结果")));
            testCase.setBusinessCategory(getCellValue(row, columnIndexMap.get("业务大类")));
            testCase.setAppName(getCellValue(row, columnIndexMap.get("应用名称")));
            testCase.setDependenciesPackage(getCellValue(row, columnIndexMap.get("依赖软件包")));
            testCase.setDependenciesRule(getCellValue(row, columnIndexMap.get("依赖规则")));
            testCase.setEnvironmentConfig(parseEnvironmentConfig(getCellValue(row, columnIndexMap.get("环境配置"))));
            
            testCases.add(testCase);
        }
    } catch (IOException e) {
        throw new ExcelParseException("解析Excel文件失败", e);
    }
    
    return testCases;
}
```

### 2.5 功能点4：脚本文件匹配功能

#### 详细描述

**算法流程图：**
```
开始
  ↓
遍历测试用例列表
  ↓
获取用例编号
  ↓
在脚本文件名列表中查找匹配
  ↓
设置脚本存在状态
  ↓
统计匹配结果
  ↓
返回匹配结果
  ↓
结束
```

**函数伪代码：**
```java
public List<TestCaseInfo> matchScripts(List<TestCaseInfo> testCases, List<String> scriptFileNames) {
    for (TestCaseInfo testCase : testCases) {
        String caseNumber = testCase.getCaseNumber();
        String expectedScriptFileName = caseNumber + ".py";
        
        boolean scriptExists = scriptFileNames.contains(expectedScriptFileName);
        testCase.setScriptExists(scriptExists);
    }
    
    return testCases;
}
```

## 3 AR开发者测试设计

### 3.1 被测对象分析

#### 3.1.1 Service层测试对象
- **TestCaseSetService类**
  - `uploadTestCaseSet(MultipartFile file, String description, String business)` - 上传用例集
  - `getTestCaseSets(int page, int pageSize)` - 获取用例集列表
  - `getTestCaseSetById(Long id)` - 根据ID获取用例集
  - `updateTestCaseSet(Long id, String description, String business)` - 更新用例集
  - `deleteTestCaseSet(Long id)` - 删除用例集
  - `downloadTestCaseSet(Long id)` - 下载用例集

- **ArchiveParseService类**
  - `parseArchive(byte[] archiveData)` - 解析压缩包
  - `validateArchive(byte[] archiveData)` - 验证压缩包结构

- **ExcelParseService类**
  - `parseExcel(byte[] excelData)` - 解析Excel文件
  - `validateExcel(byte[] excelData)` - 验证Excel文件

- **ScriptMatchService类**
  - `matchScripts(List<TestCaseInfo> testCases, List<String> scriptFileNames)` - 匹配脚本文件

#### 3.1.2 Controller层测试对象
- **TestCaseSetController类**
  - `uploadTestCaseSet(MultipartFile file, String description, String business)` - 上传用例集API
  - `getTestCaseSets(int page, int pageSize)` - 获取用例集列表API
  - `getTestCaseSet(Long id)` - 获取用例集详情API
  - `updateTestCaseSet(Long id, UpdateTestCaseSetRequest request)` - 更新用例集API
  - `deleteTestCaseSet(Long id)` - 删除用例集API
  - `downloadTestCaseSet(Long id)` - 下载用例集API
  - `getTestCases(Long id, int page, int pageSize)` - 获取测试用例列表API
  - `getMissingScripts(Long id)` - 获取缺失脚本列表API

#### 3.1.3 Entity层测试对象
- **TestCaseSet类**
  - 构造函数、Getter和Setter方法
  - `equals(Object o)` - 对象相等性比较
  - `hashCode()` - 哈希码计算
  - `toString()` - 字符串表示

- **TestCase类**
  - 构造函数、Getter和Setter方法
  - `equals(Object o)` - 对象相等性比较
  - `hashCode()` - 哈希码计算
  - `toString()` - 字符串表示

### 3.2 测试因子分析

#### 3.2.1 文件相关测试因子
- **文件大小**：空文件、正常大小、超大文件（>100MB）
- **文件类型**：ZIP文件、非ZIP文件、无扩展名文件
- **文件名格式**：正确格式、错误格式、特殊字符、中文名称
- **文件内容**：空内容、正常内容、损坏内容

#### 3.2.2 数据相关测试因子
- **用例集名称**：正常名称、空名称、超长名称、特殊字符
- **用例集版本**：正常版本、空版本、超长版本、特殊字符
- **描述信息**：正常描述、空描述、超长描述
- **业务类型**：VPN阻断、VPN_BLOCK、其他业务类型

#### 3.2.3 异常场景测试因子
- **数据库异常**：连接失败、查询超时、数据不存在
- **文件系统异常**：磁盘空间不足、权限不足
- **网络异常**：连接超时、传输中断
- **业务异常**：重复数据、数据冲突、参数错误

### 3.3 测试用例设计列表

#### 3.3.1 TestCaseSetService测试用例（15个）

| 测试用例ID | 测试方法名 | 测试场景 | 测试描述 |
|------------|------------|----------|----------|
| TC_SERVICE_001 | testUploadTestCaseSetSuccess | 正常场景 | 上传用例集成功（包含压缩包解析） |
| TC_SERVICE_002 | testUploadTestCaseSetEmptyFile | 异常场景 | 上传空文件 |
| TC_SERVICE_003 | testUploadTestCaseSetFileTooLarge | 异常场景 | 上传文件过大（>100MB） |
| TC_SERVICE_004 | testUploadTestCaseSetInvalidFileType | 异常场景 | 上传非ZIP格式文件 |
| TC_SERVICE_005 | testUploadTestCaseSetInvalidFileNameFormat | 异常场景 | 上传文件名格式错误 |
| TC_SERVICE_006 | testUploadTestCaseSetDuplicateNameVersion | 异常场景 | 上传重复名称和版本 |
| TC_SERVICE_007 | testGetTestCaseSets | 正常场景 | 获取用例集列表成功 |
| TC_SERVICE_008 | testGetTestCaseSetById | 正常场景 | 根据ID获取用例集成功 |
| TC_SERVICE_009 | testGetTestCaseSetByIdNotFound | 异常场景 | 根据ID获取用例集失败（不存在） |
| TC_SERVICE_010 | testUpdateTestCaseSetSuccess | 正常场景 | 更新用例集成功 |
| TC_SERVICE_011 | testUpdateTestCaseSetNotFound | 异常场景 | 更新不存在的用例集 |
| TC_SERVICE_012 | testDeleteTestCaseSetSuccess | 正常场景 | 删除用例集成功 |
| TC_SERVICE_013 | testDeleteTestCaseSetNotFound | 异常场景 | 删除不存在的用例集 |
| TC_SERVICE_014 | testDownloadTestCaseSetSuccess | 正常场景 | 下载用例集成功 |
| TC_SERVICE_015 | testDownloadTestCaseSetNotFound | 异常场景 | 下载不存在的用例集 |

#### 3.3.2 ArchiveParseService测试用例（8个）

| 测试用例ID | 测试方法名 | 测试场景 | 测试描述 |
|------------|------------|----------|----------|
| TC_ARCHIVE_001 | testParseArchiveSuccess | 正常场景 | 解析有效ZIP文件成功 |
| TC_ARCHIVE_002 | testParseArchiveWithCasesXlsx | 正常场景 | 解析包含cases.xlsx的ZIP文件 |
| TC_ARCHIVE_003 | testParseArchiveWithScripts | 正常场景 | 解析包含scripts目录的ZIP文件 |
| TC_ARCHIVE_004 | testParseArchiveNoCasesXlsx | 异常场景 | 解析不包含cases.xlsx的ZIP文件 |
| TC_ARCHIVE_005 | testParseArchiveNoScripts | 正常场景 | 解析不包含scripts目录的ZIP文件 |
| TC_ARCHIVE_006 | testParseArchiveInvalidFormat | 异常场景 | 解析无效格式文件 |
| TC_ARCHIVE_007 | testParseArchiveEmptyFile | 异常场景 | 解析空文件 |
| TC_ARCHIVE_008 | testParseArchiveCorruptedFile | 异常场景 | 解析损坏的ZIP文件 |

#### 3.3.3 ExcelParseService测试用例（6个）

| 测试用例ID | 测试方法名 | 测试场景 | 测试描述 |
|------------|------------|----------|----------|
| TC_EXCEL_001 | testParseExcelSuccess | 正常场景 | 解析有效Excel数据成功 |
| TC_EXCEL_002 | testParseExcelEmptyFile | 异常场景 | 解析空Excel文件失败 |
| TC_EXCEL_003 | testParseExcelInvalidFormat | 异常场景 | 解析无效格式Excel文件失败 |
| TC_EXCEL_004 | testParseExcelMissingColumns | 异常场景 | 解析缺少必要列的Excel文件 |
| TC_EXCEL_005 | testParseExcelEmptyData | 正常场景 | 解析无数据行的Excel文件 |
| TC_EXCEL_006 | testParseExcelSpecialCharacters | 正常场景 | 解析包含特殊字符的Excel文件 |

#### 3.3.4 ScriptMatchService测试用例（4个）

| 测试用例ID | 测试方法名 | 测试场景 | 测试描述 |
|------------|------------|----------|----------|
| TC_SCRIPT_001 | testMatchScriptsAllMatched | 正常场景 | 所有脚本匹配成功 |
| TC_SCRIPT_002 | testMatchScriptsPartialMatched | 正常场景 | 部分脚本匹配成功 |
| TC_SCRIPT_003 | testMatchScriptsNoMatched | 正常场景 | 无脚本匹配 |
| TC_SCRIPT_004 | testMatchScriptsExtraScripts | 正常场景 | 存在额外脚本文件 |

#### 3.3.5 TestCaseSetController测试用例（16个）

| 测试用例ID | 测试方法名 | 测试场景 | 测试描述 |
|------------|------------|----------|----------|
| TC_CONTROLLER_001 | testUploadTestCaseSetSuccess | 正常场景 | 上传用例集API成功 |
| TC_CONTROLLER_002 | testUploadTestCaseSetWithIllegalArgumentException | 异常场景 | 上传用例集API参数错误 |
| TC_CONTROLLER_003 | testUploadTestCaseSetWithException | 异常场景 | 上传用例集API异常 |
| TC_CONTROLLER_004 | testGetTestCaseSetsSuccess | 正常场景 | 获取用例集列表API成功 |
| TC_CONTROLLER_005 | testGetTestCaseSetsWithException | 异常场景 | 获取用例集列表API异常 |
| TC_CONTROLLER_006 | testGetTestCaseSetSuccess | 正常场景 | 获取用例集详情API成功 |
| TC_CONTROLLER_007 | testGetTestCaseSetNotFound | 异常场景 | 获取用例集详情API（不存在） |
| TC_CONTROLLER_008 | testGetTestCaseSetWithException | 异常场景 | 获取用例集详情API异常 |
| TC_CONTROLLER_009 | testUpdateTestCaseSetSuccess | 正常场景 | 更新用例集API成功 |
| TC_CONTROLLER_010 | testUpdateTestCaseSetWithIllegalArgumentException | 异常场景 | 更新用例集API参数错误 |
| TC_CONTROLLER_011 | testUpdateTestCaseSetWithException | 异常场景 | 更新用例集API异常 |
| TC_CONTROLLER_012 | testDeleteTestCaseSetSuccess | 正常场景 | 删除用例集API成功 |
| TC_CONTROLLER_013 | testDeleteTestCaseSetWithException | 异常场景 | 删除用例集API异常 |
| TC_CONTROLLER_014 | testDownloadTestCaseSetSuccess | 正常场景 | 下载用例集API成功 |
| TC_CONTROLLER_015 | testDownloadTestCaseSetNotFound | 异常场景 | 下载用例集API（不存在） |
| TC_CONTROLLER_016 | testDownloadTestCaseSetWithException | 异常场景 | 下载用例集API异常 |

#### 3.3.6 实体测试用例（12个）

**TestCaseSet实体测试用例（6个）：**

| 测试用例ID | 测试方法名 | 测试场景 | 测试描述 |
|------------|------------|----------|----------|
| TC_ENTITY_001 | testDefaultConstructor | 正常场景 | 默认构造函数测试 |
| TC_ENTITY_002 | testParameterizedConstructor | 正常场景 | 带参数构造函数测试 |
| TC_ENTITY_003 | testGettersAndSetters | 正常场景 | Getter和Setter方法测试 |
| TC_ENTITY_004 | testEquals | 正常场景 | equals方法测试 |
| TC_ENTITY_005 | testHashCode | 正常场景 | hashCode方法测试 |
| TC_ENTITY_006 | testToString | 正常场景 | toString方法测试 |

**TestCase实体测试用例（6个）：**

| 测试用例ID | 测试方法名 | 测试场景 | 测试描述 |
|------------|------------|----------|----------|
| TC_TESTCASE_ENTITY_001 | testDefaultConstructor | 正常场景 | 默认构造函数测试 |
| TC_TESTCASE_ENTITY_002 | testParameterizedConstructor | 正常场景 | 带参数构造函数测试 |
| TC_TESTCASE_ENTITY_003 | testGettersAndSetters | 正常场景 | Getter和Setter方法测试 |
| TC_TESTCASE_ENTITY_004 | testEquals | 正常场景 | equals方法测试 |
| TC_TESTCASE_ENTITY_005 | testHashCode | 正常场景 | hashCode方法测试 |
| TC_TESTCASE_ENTITY_006 | testToString | 正常场景 | toString方法测试 |

### 3.4 测试覆盖率统计
- **总测试用例数**：61个
- **Service层覆盖率**：33个测试用例，覆盖所有公共方法
- **Controller层覆盖率**：16个测试用例，覆盖所有API端点
- **Entity层覆盖率**：12个测试用例，覆盖所有核心方法
- **整体代码覆盖率**：预计超过85%

### 3.5 测试实现技术
- **测试框架**：JUnit 4 + Mockito 4.11.0
- **Mock策略**：使用Mockito模拟依赖对象
- **测试数据管理**：使用Builder模式构建测试数据
- **测试隔离**：每个测试用例使用独立的测试数据

## 4 数据库设计变更说明

### 4.1 environment_config 字段类型修改

**修改时间**：2025-09-23  
**修改内容**：将 `test_case` 表中的 `environment_config` 字段类型从 `JSONB` 修改为 `TEXT`

**修改原因**：
1. **简化数据存储**：TEXT 类型更加简单直接，无需复杂的 JSON 类型转换
2. **避免类型转换问题**：MyBatis 在处理 JSONB 类型时容易出现类型转换错误
3. **提高兼容性**：TEXT 类型在所有数据库版本中都有良好支持
4. **提升写入性能**：TEXT 类型写入速度更快，无需 JSON 格式验证
5. **保持灵活性**：TEXT 类型可以存储任意格式的环境配置信息，包括 JSON 字符串

**影响范围**：
- 数据库表结构：`test_case.environment_config` 字段类型变更
- DAO 层：移除 JSONB 类型转换语法（`::jsonb`）
- 数据存储：环境配置信息以文本形式存储，支持 JSON 字符串格式

**迁移脚本**：`database/alter_environment_config_to_text.sql`
